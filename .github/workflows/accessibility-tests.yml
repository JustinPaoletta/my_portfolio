name: Accessibility Tests

on:
  # Only run on pull requests to avoid duplicate runs
  # (pushes to PR branches will trigger via pull_request event)
  pull_request:
    branches: [main, master]
  # Run on direct pushes to main/master (merged PRs)
  push:
    branches: [main, master]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  accessibility:
    name: Run Accessibility Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          # Disable cache to avoid optional dependency issues with rolldown

      - name: Install dependencies
        # Workaround for npm bug with optional dependencies (https://github.com/npm/cli/issues/4828)
        # Rolldown requires native bindings that may not be installed correctly
        # Use npm install which handles optional dependencies better than npm ci
        run: npm install --no-audit --no-fund --prefer-offline=false

      - name: Fix rolldown native bindings
        # Always force reinstall rolldown-vite to ensure native bindings are installed
        # This is necessary due to npm bug with optional dependencies in CI
        run: |
          echo "Ensuring rolldown native bindings are installed..."
          npm install --no-save --force rolldown-vite
          npm install --no-save @rolldown/binding-linux-x64-gnu || echo "Note: Binding may already be installed via rolldown-vite"

      - name: Get installed Playwright version
        run: |
          echo "Playwright version:"
          npm list @playwright/test

      - name: Install Playwright Browsers
        run: |
          echo "Installing Playwright browsers with system dependencies..."
          # Use the local installation to ensure version match
          node_modules/.bin/playwright install --with-deps chromium firefox webkit

      - name: Verify browser installation
        run: |
          echo "Checking installed browsers..."
          ls -la ~/.cache/ms-playwright/ || echo "ERROR: Browser cache directory not found!"
          if [ -d ~/.cache/ms-playwright/chromium-* ]; then echo "✓ Chromium installed"; else echo "✗ Chromium NOT installed"; fi
          if [ -d ~/.cache/ms-playwright/firefox-* ]; then echo "✓ Firefox installed"; else echo "✗ Firefox NOT installed"; fi
          if [ -d ~/.cache/ms-playwright/webkit-* ]; then echo "✓ WebKit installed"; else echo "✗ WebKit NOT installed"; fi

      - name: Set up test environment variables
        run: cp .env.test .env.local

      - name: Run ESLint accessibility checks
        run: npm run lint:ci

      - name: Run accessibility tests
        run: npm run test:a11y

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: playwright-accessibility-report
          path: playwright-report/
          retention-days: 30

      - name: Upload accessibility test results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: accessibility-test-results
          path: test-results/
          retention-days: 30

  # Optional: Generate and comment accessibility report on PRs
  accessibility-report:
    name: Accessibility Report
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && success()
    needs: accessibility

    steps:
      - name: Download accessibility results
        uses: actions/download-artifact@v6
        with:
          name: accessibility-test-results
        continue-on-error: true

      - name: Comment PR with results
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const report = '✅ Accessibility tests passed! All WCAG compliance checks successful.';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
